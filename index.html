<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>밴픽 테스트</title>
<style>
body { font-family: sans-serif; background: #222; color: #eee; text-align: center; }
.hidden { display: none; }
select, button { margin: 10px; padding: 5px; }
.cards { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
.card { width: 80px; height: 100px; border: 2px solid #555; margin: 5px;
       display: flex; flex-direction: column; align-items: center; justify-content: center;
       background: #333; cursor: pointer; transition: border 0.2s; }
.card img { width: 70px; height: 70px; object-fit: cover; }
.selected { border: 3px solid #0f0; }
#log { margin-top: 20px; max-height: 300px; overflow-y: auto; text-align: left; border-top: 1px solid #555; padding-top: 10px;}
#finishTurnBtn {
  margin-top: 20px;
  padding: 15px 30px;
  font-size: 18px;
  font-weight: bold;
  background-color: #0f0;
  color: #222;
  border: none;
  cursor: pointer;
  transition: 0.2s;
}
#finishTurnBtn:disabled {
  background-color: #555;
  cursor: not-allowed;
}
</style>
</head>
<body>

<h1>밴픽 테스트</h1>

<!-- 세트 선택 -->
<div id="setSelect">
  <h2>세트 번호를 선택하세요</h2>
  <select id="setNumber">
    <option value="1">1세트</option>
    <option value="2">2세트</option>
    <option value="3">3세트</option>
    <option value="4">4세트</option>
    <option value="5">5세트</option>
  </select>
  <button onclick="goMapSelect()">다음</button>
</div>

<!-- 맵 선택 -->
<div id="mapSelect" class="hidden">
  <h2>맵을 선택하세요</h2>
  <select id="mapNumber">
    <option value="1">맵 1</option>
    <option value="2">맵 2</option>
    <option value="3">맵 3</option>
    <option value="4">맵 4</option>
    <option value="5">맵 5</option>
    <option value="6">맵 6</option>
    <option value="7">맵 7</option>
    <option value="8">맵 8</option>
  </select>
  <button onclick="goRoleSelect()">다음</button>
</div>

<!-- 진영 선택 -->
<div id="roleSelect" class="hidden">
  <h2>진영을 선택하세요</h2>
  <button onclick="chooseRole('survivor')">생존자</button>
  <button onclick="chooseRole('hunter')">감시자</button>
</div>

<!-- 밴픽 진행 -->
<div id="draftPhase" class="hidden">
  <h2 id="turnInfo">턴 진행 중...</h2>
  <div class="cards" id="cardList"></div>
  <button id="finishTurnBtn" onclick="finishTurn(selectedThisTurn)" disabled>완료</button>
</div>

<div id="log"></div>

<script>
let currentSet = 1;
let currentMap = 1;
let playerRole = null;
let currentTurn = 0;
let timerId = null;
let timeLeft = 0;
let selectedThisTurn = [];

// 샘플 캐릭터 데이터
let survivors = Array.from({length: 50}, (_, i) => ({name: `생존자${i+1}`, img: "https://via.placeholder.com/70"}));
let hunters   = Array.from({length: 33}, (_, i) => ({name: `감시자${i+1}`, img: "https://via.placeholder.com/70"}));

// 세트별 밴픽 순서 (간단화)
let setFlows = {
  1: [
    {side: "hunter", action: "ban", target: "survivor", count: 2, time: 120},
    {side: "survivor", action: "pick", target: "survivor", count: 2, time: 120},
    {side: "hunter", action: "ban", target: "survivor", count: 1, time: 60},
    {side: "survivor", action: "pick", target: "survivor", count: 1, time: 60},
    {side: "hunter", action: "ban", target: "survivor", count: 1, time: 60},
    {side: "survivor", action: "pick", target: "survivor", count: 1, time: 60},
    {side: "survivor", action: "ready", target: "trait", count: 0, time: 120},
    {side: "hunter", action: "pick", target: "hunter", count: 1, time: 120}
  ]
};
setFlows[2] = setFlows[1];
setFlows[3] = setFlows[1];
setFlows[4] = setFlows[1];
setFlows[5] = setFlows[1];

// 선택 캐릭터 저장
let finalSurvivors = [];
let finalHunter = null;

function goMapSelect() {
  currentSet = parseInt(document.getElementById("setNumber").value);
  document.getElementById("setSelect").classList.add("hidden");
  document.getElementById("mapSelect").classList.remove("hidden");
}
function goRoleSelect() {
  currentMap = parseInt(document.getElementById("mapNumber").value);
  document.getElementById("mapSelect").classList.add("hidden");
  document.getElementById("roleSelect").classList.remove("hidden");
}
function chooseRole(role) {
  playerRole = role;
  document.getElementById("roleSelect").classList.add("hidden");
  document.getElementById("draftPhase").classList.remove("hidden");
  startTurn();
}

function startTurn() {
  clearInterval(timerId);
  selectedThisTurn = [];
  document.getElementById("finishTurnBtn").disabled = true;

  let flow = setFlows[currentSet];
  if (currentTurn >= flow.length) {
    showFinalLineup();
    return;
  }

  let turn = flow[currentTurn];
  document.getElementById("turnInfo").innerText =
    `[${turn.side}] ${turn.target} ${turn.action} ${turn.count > 0 ? turn.count + "개" : ""}`;

  renderCards(turn.target, turn.count);
  startTimer(turn.time);
}

function renderCards(target, maxCount) {
  const listDiv = document.getElementById("cardList");
  listDiv.innerHTML = "";
  const pool = target === "survivor" ? survivors : hunters;
  selectedThisTurn = [];
  const finishBtn = document.getElementById("finishTurnBtn");
  finishBtn.disabled = true;

  let turn = setFlows[currentSet][currentTurn];
  const isTraitTurn = turn.action === "ready";

  pool.forEach(c => {
    let div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<img src="${c.img}"><span>${c.name}</span>`;
    if(!isTraitTurn){
      div.onclick = () => {
        if (div.classList.contains("selected")) {
          div.classList.remove("selected");
          selectedThisTurn = selectedThisTurn.filter(x => x !== c);
        } else {
          if (selectedThisTurn.length >= maxCount && maxCount !== 0) return;
          div.classList.add("selected");
          selectedThisTurn.push(c);
        }
        finishBtn.disabled = isTraitTurn ? false : selectedThisTurn.length !== maxCount;
      };
    }
    listDiv.appendChild(div);
  });

  if(isTraitTurn) finishBtn.disabled = false;
}

function startTimer(seconds) {
  timeLeft = seconds;
  updateTimerDisplay();
  clearInterval(timerId);
  timerId = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if (timeLeft <= 0) {
      clearInterval(timerId);
      finishTurn([]); // 시간 종료 시 선택 없음 처리
    }
  }, 1000);
}

function updateTimerDisplay() {
  let turn = setFlows[currentSet][currentTurn];
  document.getElementById("turnInfo").innerText =
    `[${turn.side}] ${turn.target} ${turn.action} ${turn.count > 0 ? turn.count + "개" : ""} | 남은시간: ${timeLeft}s`;
}

function finishTurn(selectedChars) {
  clearInterval(timerId);
  if(!selectedChars || selectedChars.length === 0) selectedChars = selectedThisTurn;

  let turn = setFlows[currentSet][currentTurn];
  const displayText = selectedChars.length > 0 ? selectedChars.map(c=>c.name).join(", ") : "(선택 없음)";
  document.getElementById("log").innerHTML += `<div>[${turn.side}] ${turn.action} → ${displayText}</div>`;

  // 최종 캐릭터 저장
  if(turn.side === "survivor" && turn.action === "pick"){
    finalSurvivors.push(...selectedChars);
  }
  if(turn.side === "hunter" && turn.action === "pick"){
    finalHunter = selectedChars[0];
  }

  currentTurn++;
  if(currentTurn >= setFlows[currentSet].length){
    showFinalLineup();
  } else {
    startTurn();
  }
}

// 최종 라인업 표시
function showFinalLineup(){
  document.getElementById("draftPhase").classList.add("hidden");
  const logDiv = document.getElementById("log");
  logDiv.innerHTML += `<h2>최종 라인업</h2>`;
  const lineupDiv = document.createElement("div");
  lineupDiv.className = "cards";

  finalSurvivors.forEach(c => {
    let div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<img src="${c.img}"><span>${c.name}</span>`;
    lineupDiv.appendChild(div);
  });

  // 간격 띄우기
  let spacer = document.createElement("div");
  spacer.style.width = "20px";
  lineupDiv.appendChild(spacer);

  if(finalHunter){
    let div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<img src="${finalHunter.img}"><span>${finalHunter.name}</span>`;
    lineupDiv.appendChild(div);
  }

  logDiv.appendChild(lineupDiv);
}
</script>

</body>
</html>
