<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>idV 가상 밴픽 시뮬레이</title>
<style>
body { font-family: sans-serif; background: #222; color: #eee; margin:0; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh;}
.hidden { display: none; }
select, button { margin: 10px; padding: 5px; }
.cards { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
.card {
  position: relative;
  width: 100px;
  height: 130px;
  border: 2px solid #555;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: #333;
  cursor: pointer;
  transition: border 0.2s, opacity 0.2s;
}

.card.picked { 
  border: 3px solid #00f; 
  opacity: 0.7; 
  cursor: not-allowed; 
}
.card img { width: 90px; height: 90px; object-fit: cover; }
.selected { border: 3px solid #0f0; }


.card.banned { opacity: 0.4; cursor: not-allowed; }
.card.banned::after { content: "X"; position: absolute; top: 5px; left: 5px; color: red; font-weight: bold; font-size: 20px; }

.card.picked { 
  border: 3px solid #00f; 
  opacity: 0.7; 
  cursor: not-allowed; 
}
.card.globalBanned { 
  border: 3px solid darkred; 
  opacity: 0.25; 
  cursor: not-allowed; 
}

#log { margin-top: 20px; max-height: 250px; overflow-y: auto; width: 90%; text-align: left; border-top: 1px solid #555; padding: 10px; }
#finishTurnBtn, #nextSetBtn, #endMatchBtn { margin-top: 20px; padding: 15px 30px; font-size: 18px; font-weight: bold; background-color: #0f0; color: #222; border: none; cursor: pointer; transition: 0.2s; }
#finishTurnBtn:disabled, #nextSetBtn:disabled, #endMatchBtn:disabled { background-color: #555; cursor: not-allowed; }
.finalLineupContainer { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 30px; }
.finalLineup { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; }
#globalOnBtn.selected, #globalOffBtn.selected { background-color: #0f0; color:#222; }
</style>
</head>
<body>

<h1>밴픽 테스트</h1>

<!-- 글로벌 밴 선택 -->
<div id="globalBanSelect">
  <h2>글로벌 밴 사용 여부</h2>
  <button id="globalOnBtn" onclick="selectGlobalBan(true)">ON</button>
  <button id="globalOffBtn" onclick="selectGlobalBan(false)">OFF</button>
  <br>
  <button id="globalNextBtn" onclick="confirmGlobalBan()" disabled>다음</button>
</div>

<!-- 세트 선택 -->
<div id="setSelect" class="hidden">
  <h2>세트 번호를 선택하세요</h2>
  <select id="setNumber">
    <option value="1">1세트</option>
    <option value="2">2세트</option>
    <option value="3">3세트</option>
    <option value="4">4세트</option>
    <option value="5">5세트</option>
  </select>
  <button onclick="goMapSelect()">다음</button>
</div>

<!-- 맵 선택 -->
<div id="mapSelect" class="hidden">
  <h2>맵을 선택하세요</h2>
  <select id="mapNumber">
    <option value="1">맵 1</option>
    <option value="2">맵 2</option>
    <option value="3">맵 3</option>
    <option value="4">맵 4</option>
    <option value="5">맵 5</option>
    <option value="6">맵 6</option>
    <option value="7">맵 7</option>
    <option value="8">맵 8</option>
  </select>
  <button onclick="goRoleSelect()">다음</button>
</div>

<!-- 진영 선택 -->
<div id="roleSelect" class="hidden">
  <h2>진영을 선택하세요</h2>
  <button onclick="chooseRole('survivor')">생존자</button>
  <button onclick="chooseRole('hunter')">감시자</button>
</div>

<!-- 밴픽 진행 -->
<div id="draftPhase" class="hidden">
  <h2 id="turnInfo">턴 진행 중...</h2>
  <div class="cards" id="cardList"></div>
  <button id="finishTurnBtn" onclick="finishTurn(selectedThisTurn)" disabled>완료</button>
</div>

<div id="log"></div>

<!-- 세트 종료 후 선택 -->
<div id="endOptions" class="hidden">
  <button id="endMatchBtn" onclick="endMatch()">경기 종료</button>
  <button id="nextSetBtn" onclick="nextSet()">다음 세트 진행</button>
</div>

<script>
let globalBan = null;
let bannedSurvivors = [];
let bannedHunters = [];
let currentSet = 1;
let currentMap = 1;
let playerRole = null;
let currentTurn = 0;
let timerId = null;
let timeLeft = 0;
let selectedThisTurn = [];
let finalSurvivors = [];
let finalHunter = null;
let currentSetPicked = {
  survivor: [],
  hunter: [],
  bannedSurvivor: [],
  bannedHunter: []
};

// 샘플 캐릭터
let survivors = Array.from({length: 50}, (_, i) => ({name: `생존자${i+1}`, img: "https://via.placeholder.com/70"}));
let hunters   = Array.from({length: 33}, (_, i) => ({name: `감시자${i+1}`, img: "https://via.placeholder.com/70"}));

// 세트별 밴픽 순서 (1세트 예시)
let setFlows = {};

for(let i=1;i<=5;i++){
  setFlows[i] = [
    {side: "hunter", action: "ban", target: "survivor", count: 2, time: 120}, // 기존 유지
  ];

  // 새로 추가되는 부분
  if(i === 2){
    setFlows[i].push({side: "survivor", action: "ban", target: "hunter", count: 1, time: 60}); // 2세트: 1개, 60초
  } else if(i >= 3){
    setFlows[i].push({side: "survivor", action: "ban", target: "hunter", count: 2, time: 60}); // 3~5세트: 2개, 60초
  }

  setFlows[i].push(
    {side: "survivor", action: "pick", target: "survivor", count: 2, time: 120}, // 기존 유지
    {side: "hunter", action: "ban", target: "survivor", count: 1, time: 60},
    {side: "survivor", action: "pick", target: "survivor", count: 1, time: 60},
    {side: "hunter", action: "ban", target: "survivor", count: 1, time: 60},
    {side: "survivor", action: "pick", target: "survivor", count: 1, time: 60},
    {side: "survivor", action: "ready", target: "trait", count: 0, time: 120},
    {side: "hunter", action: "pick", target: "hunter", count: 1, time: 120}
  );
}

function selectGlobalBan(isOn){
  globalBan = isOn;
  document.getElementById("globalOnBtn").classList.toggle("selected", isOn);
  document.getElementById("globalOffBtn").classList.toggle("selected", !isOn);
  document.getElementById("globalNextBtn").disabled = false;
}

function confirmGlobalBan(){
  if(globalBan === null){ alert("글로벌 밴 여부를 선택해주세요."); return; }
  document.getElementById("globalBanSelect").classList.add("hidden");
  document.getElementById("setSelect").classList.remove("hidden");
}

function goMapSelect(){
  currentSet = parseInt(document.getElementById("setNumber").value);
  document.getElementById("setSelect").classList.add("hidden");
  document.getElementById("mapSelect").classList.remove("hidden");
}

function goRoleSelect(){
  currentMap = parseInt(document.getElementById("mapNumber").value);
  document.getElementById("mapSelect").classList.add("hidden");
  document.getElementById("roleSelect").classList.remove("hidden");
}

function chooseRole(role){
  playerRole = role;
  document.getElementById("roleSelect").classList.add("hidden");
  document.getElementById("draftPhase").classList.remove("hidden");
  startTurn();
}

function startTurn(){
  clearInterval(timerId);
  selectedThisTurn = [];
  document.getElementById("finishTurnBtn").disabled = true;

  let flow = setFlows[currentSet];
  if(currentTurn >= flow.length){
    showEndOptions();
    return;
  }

  let turn = flow[currentTurn];
  document.getElementById("turnInfo").innerText = `[${turn.side}] ${turn.target} ${turn.action} ${turn.count>0?turn.count+"개":""}`;
  renderCards(turn.target, turn.count);
  startTimer(turn.time);
}

function renderCards(target, maxCount){
  const listDiv = document.getElementById("cardList");
  listDiv.innerHTML = "";
  const pool = target==="survivor"?survivors:hunters;
  const finishBtn = document.getElementById("finishTurnBtn");
  const turn = setFlows[currentSet][currentTurn];
  const isTraitTurn = turn.action==="ready";


pool.forEach(c=>{
  let div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `<img src="${c.img}"><span>${c.name}</span>`;

  const isGlobalBanned = (target==="survivor" && bannedSurvivors.includes(c.name)) ||
                         (target==="hunter" && bannedHunters.includes(c.name));
  const isPickedThisSet = (target==="survivor" && currentSetPicked.survivor.includes(c.name)) ||
                          (target==="hunter" && currentSetPicked.hunter.includes(c.name));
  const isBannedThisSet = (target==="survivor" && currentSetPicked.bannedSurvivor.includes(c.name)) ||
                          (target==="hunter" && currentSetPicked.bannedHunter.includes(c.name));

  if(isGlobalBanned){
    div.classList.add("globalBanned");
    div.onclick = null;
  } else if(isBannedThisSet){
    div.classList.add("banned");
    div.onclick = null;
  } else if(isPickedThisSet){
    div.classList.add("picked");
    div.onclick = null;
  } else if(!isTraitTurn){
    div.onclick = ()=>{
      if(div.classList.contains("selected")){
        div.classList.remove("selected");
        selectedThisTurn = selectedThisTurn.filter(x=>x!==c);
      } else {
        if(selectedThisTurn.length >= maxCount && maxCount!==0) return;
        div.classList.add("selected");
        selectedThisTurn.push(c);
      }
      finishBtn.disabled = isTraitTurn?false:selectedThisTurn.length!==maxCount;
    };
  }

  listDiv.appendChild(div);
});

  if(isTraitTurn) finishBtn.disabled = false;
}


function startTimer(seconds){
  timeLeft = seconds;
  updateTimerDisplay();
  clearInterval(timerId);
  timerId = setInterval(()=>{
    timeLeft--;
    updateTimerDisplay();
    if(timeLeft<=0){
      clearInterval(timerId);
      finishTurn([]);
    }
  },1000);
}

function updateTimerDisplay(){
  let turn = setFlows[currentSet][currentTurn];
  document.getElementById("turnInfo").innerText = `[${turn.side}] ${turn.target} ${turn.action} ${turn.count>0?turn.count+"개":""} | 남은시간: ${timeLeft}s`;
}

function finishTurn(selectedChars){
  clearInterval(timerId);
  if(!selectedChars || selectedChars.length===0) selectedChars = selectedThisTurn;
  let turn = setFlows[currentSet][currentTurn];
  const displayText = selectedChars.length>0?selectedChars.map(c=>c.name).join(", ") : "(선택 없음)";
  document.getElementById("log").innerHTML += `<div>[${turn.side}] ${turn.action} → ${displayText}</div>`;

  // 현재 세트에 반영
  if(turn.side==="survivor" && turn.action==="pick") currentSetPicked.survivor.push(...selectedChars.map(c=>c.name));
  if(turn.side==="hunter" && turn.action==="pick") currentSetPicked.hunter.push(...selectedChars.map(c=>c.name));

  if(turn.side==="hunter" && turn.action==="ban") currentSetPicked.bannedSurvivor.push(...selectedChars.map(c=>c.name));
  if(turn.side==="survivor" && turn.action==="ban") currentSetPicked.bannedHunter.push(...selectedChars.map(c=>c.name));

  // 최종 저장
  if(turn.side === "survivor" && turn.action === "pick") finalSurvivors.push(...selectedChars);
  if(turn.side === "hunter" && turn.action === "pick") finalHunter = selectedChars[0];

  currentTurn++;
  if(currentTurn >= setFlows[currentSet].length){
    // 글로벌 밴 적용
    if(globalBan){
      bannedSurvivors.push(...currentSetPicked.survivor.slice(0,3).filter(c=>!bannedSurvivors.includes(c)));
      bannedHunters.push(...currentSetPicked.hunter.filter(c=>!bannedHunters.includes(c)));
    }
    // 세트 끝났을 때 최종 라인업 화면을 먼저 보여줍니다
    showFinalLineup();
  } else {
    startTurn();
  }
}



function showFinalLineup(){
  // 카드 선택 화면 숨기기
  document.getElementById("draftPhase").classList.add("hidden");

  // 기존 finalLineupContainer 제거 (중복 방지)
  const existing = document.querySelector('.finalLineupContainer');
  if(existing) existing.remove();

  // 로그에 히스토리 추가
  const logDiv = document.getElementById("log");
  logDiv.innerHTML += `<h2>밴픽 히스토리</h2>`;

  // 최종 라인업 컨테이너 생성
  const container = document.createElement("div");
  container.className = "finalLineupContainer";
  container.id = "finalLineupContainer";  // ⭐ id 부여
  container.innerHTML = "<h2>최종 라인업</h2>";

  const lineupDiv = document.createElement("div");
  lineupDiv.className = "finalLineup";

  // 생존자 4명
  finalSurvivors.slice(0,4).forEach(c => {
    let div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<img src="${c.img}"><span>${c.name}</span>`;
    lineupDiv.appendChild(div);
  });

  // 간격
  let spacer = document.createElement("div");
  spacer.style.width = "20px";
  lineupDiv.appendChild(spacer);

  // 감시자
  if(finalHunter){
    let div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<img src="${finalHunter.img}"><span>${finalHunter.name}</span>`;
    lineupDiv.appendChild(div);
  }

  container.appendChild(lineupDiv);

  // ⭐ log 바깥 → body 맨 아래에 붙임
  document.body.appendChild(container);

  // 종료/다음 세트 옵션 표시
  showEndOptions();
}


function showEndOptions(){
  const endDiv = document.getElementById("endOptions");
  endDiv.classList.remove("hidden");

  if(globalBan){
    // ON이면 두 버튼 활성
    document.getElementById("nextSetBtn").style.display = "inline-block";
    document.getElementById("endMatchBtn").style.display = "inline-block";
  } else {
    // OFF이면 종료 버튼만
    document.getElementById("nextSetBtn").style.display = "none";
    document.getElementById("endMatchBtn").style.display = "inline-block";
  }
}

function endMatch(){
  // 최종 라인업 제거 ⭐
  const existing = document.getElementById("finalLineupContainer");
  if(existing) existing.remove();

  // 초기화
  bannedSurvivors = [];
  bannedHunters = [];
  currentSet = 1;
  currentMap = 1;
  playerRole = null;
  currentTurn = 0;
  selectedThisTurn = [];
  finalSurvivors = [];
  finalHunter = null;
  currentSetPicked = {survivor:[], hunter:[], bannedSurvivor:[], bannedHunter:[]};

  document.getElementById("endOptions").classList.add("hidden");
  document.getElementById("log").innerHTML = "";
  document.getElementById("draftPhase").classList.add("hidden");
  document.getElementById("setSelect").classList.add("hidden");
  document.getElementById("mapSelect").classList.add("hidden");
  document.getElementById("roleSelect").classList.add("hidden");

  document.getElementById("globalBanSelect").classList.remove("hidden");
  document.getElementById("globalNextBtn").disabled = true;
  document.getElementById("globalOnBtn").classList.remove("selected");
  document.getElementById("globalOffBtn").classList.remove("selected");
}

function nextSet(){
  // 이전 세트 최종 라인업 제거 ⭐
  const existing = document.getElementById("finalLineupContainer");
  if(existing) existing.remove();

  currentSet++;
  currentTurn = 0;
  selectedThisTurn = [];
  finalSurvivors = [];
  finalHunter = null;
  currentSetPicked = {survivor:[], hunter:[], bannedSurvivor:[], bannedHunter:[]};

  document.getElementById("endOptions").classList.add("hidden");
  document.getElementById("draftPhase").classList.remove("hidden");
  document.getElementById("log").innerHTML = "";

  startTurn();
}


</script>
</body>
</html>

